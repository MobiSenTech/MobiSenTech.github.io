<!DOCTYPE html>
<html>
<head>
    <title>ä½“è‚²æ´»åŠ¨ç§¯åˆ†ç³»ç»Ÿ</title>
    <meta charset="UTF-8">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.17.0/dist/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: 'Comic Sans MS', cursive;
            margin: 20px;
            transition: background 0.3s;
            background-size: cover;
            background-attachment: fixed;
            position: relative;
        }
        
        /* æ·»åŠ èƒŒæ™¯è™šåŒ–æ•ˆæœ */
        body::before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            background-color: rgba(255, 255, 255, 0.3);
        }
        
        /* å…¶ä»–æ ·å¼ä¿æŒåŸæ · */
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            text-align: center;
            color: #2c3e50;
            text-shadow: 2px 2px #fff;
            font-size: 2.5em;
            margin: 20px 0;
        }
        .header-btns {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
        }
        button {
            background: #3498db;
            border: none;
            padding: 10px 20px;
            border-radius: 15px;
            cursor: pointer;
            transition: transform 0.2s;
            color: white;
        }
        button:hover {
            transform: scale(1.1);
            background: #2980b9;
        }
        .groups {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 30px;
            margin-top: 30px;
        }
        .group {
            background: #ecf0f1;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            text-align: center;
        }
        .group h2 {
            margin: 0 0 20px 0;
            color: #2c3e50;
        }
        .progress-container {
            background: #bdc3c7;
            height: 30px;
            border-radius: 15px;
            margin: 20px 0;
            position: relative;
            overflow: visible;
        }
        .progress-bar {
            height: 100%;
            border-radius: 15px;
            transition: width 0.3s ease;
            position: relative;
        }
        .group:nth-child(1) .progress-bar { background: #e74c3c; }
        .group:nth-child(2) .progress-bar { background: #3498db; }
        .group:nth-child(3) .progress-bar { background: #2ecc71; }
        .group:nth-child(4) .progress-bar { background: #f1c40f; }
        .football {
            position: absolute;
            right: -15px;
            top: -10px;
            font-size: 1.5em;
            color: #2c3e50;
            transition: left 0.3s ease;
        }
        .score-text {
            margin-top: 10px;
            font-size: 1.2em;
            color: #2c3e50;
        }
        .controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 15px 0;
        }
        input[type="number"] {
            width: 60px;
            padding: 5px;
            border-radius: 10px;
            border: 2px solid #3498db;
            text-align: center;
        }
        #rankBtn i {
            color: #f1c40f;
        }
        .batch-controls {
            margin: 30px 0;
            text-align: center;
            position: sticky;
            top: 10px;
            z-index: 100;
            background: rgba(255,255,255,0.9);
            padding: 15px;
            border-radius: 15px;
        }
        
        /* é‡æ–°è®¾è®¡æ’è¡Œæ¦œæ ·å¼ - é¢å¥–å°æ•ˆæœ */
        .leaderboard {
            margin-top: 40px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .leaderboard h2 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
        }
        
        .podium-container {
            display: flex;
            justify-content: center;
            align-items: flex-end;
            height: 300px;
            margin: 0 auto;
            max-width: 600px;
            position: relative;
        }
        
        .podium-step {
            width: 150px;
            margin: 0 5px;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            transition: transform 0.3s ease;
        }
        
        .podium-rank {
            font-size: 4em;
            font-weight: bold;
            color: #f1c40f;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            margin-bottom: 10px;
        }
        
        .podium-block {
            width: 100%;
            border-radius: 10px 10px 0 0;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .podium-name {
            position: absolute;
            top: -30px;
            width: 100%;
            text-align: center;
            font-weight: bold;
            color: #2c3e50;
            font-size: 1.2em;
        }
        
        .podium-score {
            position: absolute;
            bottom: 10px;
            width: 100%;
            text-align: center;
            font-weight: bold;
            color: #2c3e50;
            font-size: 1.5em;
        }
        
        /* ç¬¬ä¸€å */
        .podium-step:nth-child(2) {
            z-index: 3;
        }
        
        .podium-step:nth-child(2) .podium-block {
            height: 200px;
            background: linear-gradient(to bottom, #ffd700, #f9f295);
            border: 3px solid #ffd700;
        }
        
        .podium-step:nth-child(2) .podium-rank {
            color: #ffd700;
        }
        
        /* ç¬¬äºŒå */
        .podium-step:nth-child(1) {
            z-index: 2;
        }
        
        .podium-step:nth-child(1) .podium-block {
            height: 150px;
            background: linear-gradient(to bottom, #c0c0c0, #e6e6e6);
            border: 3px solid #c0c0c0;
        }
        
        .podium-step:nth-child(1) .podium-rank {
            color: #c0c0c0;
        }
        
        /* ç¬¬ä¸‰å */
        .podium-step:nth-child(3) {
            z-index: 1;
        }
        
        .podium-step:nth-child(3) .podium-block {
            height: 100px;
            background: linear-gradient(to bottom, #cd7f32, #e8b27d);
            border: 3px solid #cd7f32;
        }
        
        .podium-step:nth-child(3) .podium-rank {
            color: #cd7f32;
        }
        
        /* æ˜Ÿæ˜Ÿæ•ˆæœ */
        .star {
            position: absolute;
            top: -40px;
            font-size: 3em;
            color: #ffd700;
            filter: drop-shadow(0 0 5px rgba(255, 215, 0, 0.7));
            animation: twinkle 1.5s infinite alternate;
        }
        
        @keyframes twinkle {
            0% { transform: scale(1); opacity: 0.8; }
            100% { transform: scale(1.2); opacity: 1; }
        }
        
        /* åº•åº§ */
        .podium-base {
            position: absolute;
            bottom: -20px;
            width: 100%;
            height: 20px;
            background: linear-gradient(to bottom, #f39c12, #e67e22);
            border-radius: 0 0 10px 10px;
            box-shadow: 0 5px 10px rgba(0,0,0,0.2);
        }
        
        /* åŠ¨ç”»æ•ˆæœ - åªä¸ºç‰¹å®šçŠ¶æ€è®¾ç½® */
        .podium-step {
            /* é»˜è®¤æ²¡æœ‰åŠ¨ç”» */
            transition: transform 0.3s ease;
        }
        
        .podium-step.highlight {
            animation: highlight 1.5s ease;
        }
        
        @keyframes highlight {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); box-shadow: 0 0 20px rgba(255, 215, 0, 0.7); }
            100% { transform: scale(1); }
        }
        
        .podium-step:nth-child(1).appear { animation-delay: 0.2s; }
        .podium-step:nth-child(2).appear { animation-delay: 0s; }
        .podium-step:nth-child(3).appear { animation-delay: 0.4s; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ† å°ç»„ç§¯åˆ†èµ› ğŸ†</h1>
        
        <div class="header-btns">
            <button onclick="document.getElementById('bgInput').click()">
                <i class="fas fa-image"></i> æ›´æ¢èƒŒæ™¯
            </button>
            <button onclick="document.getElementById('fileInput').click()">
                <i class="fas fa-file-import"></i> å¯¼å…¥åå•
            </button>
            <button id="rankBtn" onclick="toggleRank()">
                <i class="fas fa-trophy"></i> æ’è¡Œæ¦œ
            </button>
        </div>

        <div class="batch-controls">
            <input type="number" id="batchValue" value="1" min="1">
            <button onclick="batchAdd()"><i class="fas fa-plus"></i> å…¨ä½“åŠ åˆ†</button>
            <button onclick="batchMinus()"><i class="fas fa-minus"></i> å…¨ä½“å‡åˆ†</button>
        </div>

        <div class="groups" id="groups"></div>
        
        <!-- æ·»åŠ æ’è¡Œæ¦œéƒ¨åˆ† -->
        <div class="leaderboard">
            <h2>ğŸ† æ’è¡Œæ¦œ ğŸ†</h2>
            <div class="rankings" id="rankings"></div>
        </div>
    </div>

    <input type="file" id="fileInput" hidden accept=".xls,.xlsx">
    <input type="file" id="bgInput" hidden accept="image/*">
    <!-- æ·»åŠ æœ¬åœ°éŸ³æ•ˆæ–‡ä»¶ -->
    <audio id="addPointSound" src="3æœˆ10æ—¥.MP3" preload="auto"></audio>

    <script>
        // èƒŒæ™¯åˆå§‹åŒ– - è®¾ç½®é»˜è®¤èƒŒæ™¯å›¾
        const savedBg = localStorage.getItem('savedBackground');
        if(savedBg) {
            document.body.style.backgroundImage = `url(${savedBg})`;
        } else {
            // è®¾ç½®é»˜è®¤èƒŒæ™¯å›¾
            document.body.style.backgroundImage = `url(1.png)`;
        }
        document.body.style.backgroundAttachment = 'fixed';
        document.body.style.backgroundSize = 'cover';
        document.body.style.backgroundPosition = 'center';

        let groups = JSON.parse(localStorage.getItem('groups')) || Array(3).fill().map((_,i) => ({
            name: `ç¬¬ ${i+1} ç»„`,
            score: 0,
            students: []
        }));

        function initGroups() {
            const container = document.getElementById('groups');
            // ç¡®ä¿åªæ˜¾ç¤ºå‰ä¸‰ç»„
            const displayGroups = groups.slice(0, 3);
            container.innerHTML = displayGroups.map((group, index) => {
                const percentage = (group.score / 20 * 100).toFixed(1);
                return `
                <div class="group">
                    <h2>${group.name}</h2>
                    <div class="progress-container">
                        <div class="progress-bar" style="width: ${percentage > 100 ? 100 : percentage}%">
                            <i class="fas fa-futbol football"></i>
                        </div>
                    </div>
                    <div class="score-text">${group.score}/20 åˆ†</div>
                    <div class="controls">
                        <button onclick="changeScore(${index}, 1)">
                            <i class="fas fa-plus"></i>
                        </button>
                        <button onclick="changeScore(${index}, -1)">
                            <i class="fas fa-minus"></i>
                        </button>
                    </div>
                </div>`
            }).join('');
            
            // æ›´æ–°æ’è¡Œæ¦œ
            updateLeaderboard();
        }

        function changeScore(index, delta) {
            let newScore = groups[index].score + delta;
            newScore = Math.max(0, Math.min(20, newScore));
            if(newScore !== groups[index].score) {
                // ä¿å­˜ä¹‹å‰çš„æ’åæƒ…å†µ
                const prevRanks = getRankPositions();
                const prevTopThree = [...groups].sort((a, b) => b.score - a.score).slice(0, 3).map(g => g.name);
                
                groups[index].score = newScore;
                
                // æ’­æ”¾çŸ­ä¿ƒçš„åŠ åˆ†éŸ³æ•ˆ
                if(delta > 0) {
                    const sound = document.getElementById('addPointSound');
                    sound.currentTime = 0; // é‡ç½®éŸ³é¢‘åˆ°å¼€å§‹ä½ç½®ï¼Œç¡®ä¿æ¯æ¬¡éƒ½èƒ½æ’­æ”¾
                    sound.play();
                }
                
                saveAndUpdate();
                
                // è·å–æ–°çš„æ’åæƒ…å†µ
                const newRanks = getRankPositions();
                const newTopThree = [...groups].sort((a, b) => b.score - a.score).slice(0, 3).map(g => g.name);
                
                // æ£€æŸ¥å‰ä¸‰åæ˜¯å¦æœ‰å˜åŒ–
                const topThreeChanged = !arraysEqual(prevTopThree, newTopThree);
                
                // åªæœ‰å½“å‰ä¸‰åæ’åºå˜åŒ–æ—¶ï¼Œæ‰è§¦å‘åŠ¨ç”»
                if (topThreeChanged) {
                    animatePodiumChanges(prevTopThree, newTopThree);
                }
            }
        }
        
        // è¾…åŠ©å‡½æ•°ï¼šæ¯”è¾ƒä¸¤ä¸ªæ•°ç»„æ˜¯å¦ç›¸ç­‰
        function arraysEqual(a, b) {
            if (a.length !== b.length) return false;
            for (let i = 0; i < a.length; i++) {
                if (a[i] !== b[i]) return false;
            }
            return true;
        }
        
        // è¾…åŠ©å‡½æ•°ï¼šè·å–å½“å‰æ’åä½ç½®
        function getRankPositions() {
            const positions = {};
            [...groups].sort((a, b) => b.score - a.score).forEach((group, index) => {
                positions[group.name] = index;
            });
            return positions;
        }
        
        // é¢å¥–å°å˜åŒ–åŠ¨ç”»å‡½æ•° - åªé’ˆå¯¹å˜åŒ–çš„ä½ç½®
        function animatePodiumChanges(prevTopThree, newTopThree) {
            // æ‰¾å‡ºå˜åŒ–çš„ä½ç½®å¹¶åªå¯¹é‚£äº›ä½ç½®åº”ç”¨åŠ¨ç”»
            for (let i = 0; i < 3; i++) {
                if (prevTopThree[i] !== newTopThree[i]) {
                    // æ ¹æ®ä½ç½®æ‰¾åˆ°å¯¹åº”çš„é¢å¥–å°å…ƒç´ 
                    let stepIndex;
                    if (i === 0) stepIndex = 1; // ç¬¬ä¸€ååœ¨ä¸­é—´
                    else if (i === 1) stepIndex = 0; // ç¬¬äºŒååœ¨å·¦è¾¹
                    else stepIndex = 2; // ç¬¬ä¸‰ååœ¨å³è¾¹
                    
                    const podiumStep = document.querySelectorAll('.podium-step')[stepIndex];
                    
                    // æ·»åŠ é«˜äº®åŠ¨ç”»æ•ˆæœ
                    podiumStep.classList.add('highlight');
                    setTimeout(() => {
                        podiumStep.classList.remove('highlight');
                    }, 1500);
                }
            }
        }

        function saveAndUpdate() {
            localStorage.setItem('groups', JSON.stringify(groups));
            initGroups();
        }

        function toggleRank() {
            groups.sort((a, b) => b.score - a.score);
            saveAndUpdate();
        }

        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];
                const jsonData = XLSX.utils.sheet_to_json(worksheet);
                
                groups = jsonData.reduce((acc, cur, index) => {
                    const groupIndex = index % 4;
                    if(!acc[groupIndex]) acc[groupIndex] = {
                        name: `ç¬¬ ${groupIndex+1} ç»„`,
                        score: 0,
                        students: []
                    };
                    acc[groupIndex].students.push(cur['å§“å']);
                    return acc;
                }, []);
                
                saveAndUpdate();
            };
            reader.readAsArrayBuffer(file);
        });

        function batchAdd() {
            const value = parseInt(document.getElementById('batchValue').value);
            const prevTopThree = [...groups].sort((a, b) => b.score - a.score).slice(0, 3).map(g => g.name);
            
            groups.forEach(g => g.score = Math.min(20, g.score + value));
            
            // æ’­æ”¾çŸ­ä¿ƒçš„åŠ åˆ†éŸ³æ•ˆ
            const sound = document.getElementById('addPointSound');
            sound.currentTime = 0;
            sound.play();
            
            saveAndUpdate();
            
            const newTopThree = [...groups].sort((a, b) => b.score - a.score).slice(0, 3).map(g => g.name);
            
            // æ£€æŸ¥å‰ä¸‰åæ˜¯å¦æœ‰å˜åŒ–
            const topThreeChanged = !arraysEqual(prevTopThree, newTopThree);
            
            // åªæœ‰å½“å‰ä¸‰åæ’åºå˜åŒ–æ—¶ï¼Œæ‰è§¦å‘åŠ¨ç”»
            if (topThreeChanged) {
                animatePodiumChanges(prevTopThree, newTopThree);
            }
        }

        function batchMinus() {
            const value = parseInt(document.getElementById('batchValue').value);
            const prevTopThree = [...groups].sort((a, b) => b.score - a.score).slice(0, 3).map(g => g.name);
            
            groups.forEach(g => g.score = Math.max(0, g.score - value));
            saveAndUpdate();
            
            const newTopThree = [...groups].sort((a, b) => b.score - a.score).slice(0, 3).map(g => g.name);
            
            // æ£€æŸ¥å‰ä¸‰åæ˜¯å¦æœ‰å˜åŒ–
            const topThreeChanged = !arraysEqual(prevTopThree, newTopThree);
            
            // åªæœ‰å½“å‰ä¸‰åæ’åºå˜åŒ–æ—¶ï¼Œæ‰è§¦å‘åŠ¨ç”»
            if (topThreeChanged) {
                animatePodiumChanges(prevTopThree, newTopThree);
            }
        }

        document.getElementById('bgInput').addEventListener('change', function(e) {
            const reader = new FileReader();
            reader.onload = () => {
                localStorage.setItem('savedBackground', reader.result);
                document.body.style.backgroundImage = `url(${reader.result})`;
                document.body.style.backgroundAttachment = 'fixed';
                document.body.style.backgroundSize = 'cover';
                document.body.style.backgroundPosition = 'center';
            }
            reader.readAsDataURL(e.target.files[0]);
        });

        // ä¿®æ”¹æ’è¡Œæ¦œæ›´æ–°å‡½æ•° - ä¸æ·»åŠ åˆå§‹åŠ¨ç”»
        function updateLeaderboard() {
            const rankingsContainer = document.getElementById('rankings');
            // åˆ›å»ºæ’åºåçš„ç»„æ•°ç»„å‰¯æœ¬
            const sortedGroups = [...groups].sort((a, b) => b.score - a.score);
            
            // åªæ˜¾ç¤ºå‰ä¸‰å
            const topThree = sortedGroups.slice(0, 3);
            
            // å¦‚æœä¸è¶³ä¸‰ç»„ï¼Œå¡«å……ç©ºæ•°æ®
            while(topThree.length < 3) {
                topThree.push({name: "æœªå®š", score: 0});
            }
            
            // åˆ›å»ºé¢å¥–å°HTML - ä¸æ·»åŠ åŠ¨ç”»ç±»
            rankingsContainer.innerHTML = `
                <div class="podium-container">
                    <!-- ç¬¬äºŒå -->
                    <div class="podium-step">
                        <div class="podium-rank">2</div>
                        <div class="podium-block">
                            <div class="podium-name">${topThree[1].name}</div>
                            <div class="podium-score">${topThree[1].score} åˆ†</div>
                        </div>
                    </div>
                    
                    <!-- ç¬¬ä¸€å -->
                    <div class="podium-step">
                        <div class="star">â­</div>
                        <div class="podium-rank">1</div>
                        <div class="podium-block">
                            <div class="podium-name">${topThree[0].name}</div>
                            <div class="podium-score">${topThree[0].score} åˆ†</div>
                        </div>
                    </div>
                    
                    <!-- ç¬¬ä¸‰å -->
                    <div class="podium-step">
                        <div class="podium-rank">3</div>
                        <div class="podium-block">
                            <div class="podium-name">${topThree[2].name}</div>
                            <div class="podium-score">${topThree[2].score} åˆ†</div>
                        </div>
                    </div>
                    
                    <!-- åº•åº§ -->
                    <div class="podium-base"></div>
                </div>
            `;
        }

        // ä¿®æ”¹é¡µé¢åŠ è½½å‡½æ•°ï¼Œä¿ç•™ä¹‹å‰çš„æ•°æ®
        window.onload = function() {
            // æ£€æŸ¥æ˜¯å¦å·²æœ‰ä¿å­˜çš„ç»„æ•°æ®
            if (!localStorage.getItem('groups')) {
                // åªæœ‰åœ¨æ²¡æœ‰ä¿å­˜æ•°æ®æ—¶æ‰åˆå§‹åŒ–ä¸ºä¸‰ä¸ªç»„
                groups = Array(3).fill().map((_,i) => ({
                    name: `ç¬¬ ${i+1} ç»„`,
                    score: 0,
                    students: []
                }));
                
                saveAndUpdate();
            } else {
                // å¦‚æœæœ‰ä¿å­˜çš„æ•°æ®ï¼Œä»localStorageåŠ è½½
                groups = JSON.parse(localStorage.getItem('groups')) || [];
                initGroups();
            }
        };

        // åˆå§‹åŒ–ç»„æ˜¾ç¤º
        initGroups();
    </script>
</body>
</html>
